- focus('login')
= message_block
- unless logged_in?
  %h1=t '.heading'
  =form_tag authengine_sessions_path do
    %table.table{:style => 'width:300px'}
      %tr
        %td= label_tag :login, t(".user_name")
        %td=text_field_tag "login"
      %tr
        %td= label_tag :password, t(".password")
        %td
          =password_field_tag "password"
          =hidden_field_tag :u2f_sign_response
      %tr
        %td
          .btn.btn-default.btn-primary#sign_up{:onclick=>'send_user_params()'}=t('.login')
        %td

- if Rails.env.production?
  = javascript_include_tag 'u2f-api.js'

- unless Rails.env.production?
  // cannot use yubikey in development as it requires https
  = javascript_include_tag 'jsrsasign/jsrsasign-4.7.0-all-min.js'
  = javascript_include_tag 'mock_yubikey'

:coffeescript
  $ ->
    remove_flash= ->
      $('.message_block').empty()
    $('#login').on('keydown',remove_flash)
    $('#password').on('keydown',remove_flash)

  @send_user_params = ->
    @authentication_pending = 1
    $.post
      url : "#{authengine_sessions_path}"
      data : $('form').serialize()
      success : u2f_challenge
      error : u2f_challenge_fail

  u2f_challenge_fail = (jqxhr, status, message)->
    $('.message_block').append("<ul class='error'><li>"+jqxhr.responseText+"</li></ul>")

  opt_timeout_seconds = 15

  u2f_challenge = (signRequest, status, jqxhr)->
    u2f.sign([signRequest], signRequestCallback, opt_timeout_seconds)

  signRequestCallback = (signResponse)->
    $('#u2f_sign_response').val(JSON.stringify(signResponse))
    @authentication_pending = 0
    $('form').submit()
