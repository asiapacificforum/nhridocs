= stylesheet_link_tag 'form_errors'
= render :partial => 'shared/confirm_delete_modal'
= javascript_include_tag 'confirm_delete_modal'
= javascript_include_tag 'ractive_validator'

.message_block
%h1=t('.heading')

#strategic_plans

%script#new_strategic_plan_template{:type => 'template/ractive'}
  .admin.well
    .row.form-inline
      .col-md-3.strategic_plan.form-group
        %label{:for => 'strategic_plan_title', :style => "padding-right:12px;"}= t('.title')
        %input.form-control#strategic_plan_title{:type => :text, :placeholder => t('.placeholder'), :name => 'strategic_plan[title]', :value => '{{title}}', 'on-keydown' => 'remove_error()', :style => "width:200px;"}
        %span.help-block#title_error= t('.title_error')
        %span.help-block#unique_title_error= t('.unique_title_error')
      .col-md-2.form-group
        %label
          %span{:style => "padding-right:18px"}= t('.copy')
          %input.form-control#copy{:type => :checkbox, :style => "position:relative; top :-3px;", :checked => '{{copy}}'}
      .col-md-2
        %button.btn.btn-success.btn-m#save{'on-click' => 'submit()'}= t('.create')

%script#strategic_plans_template{:type => 'template/ractive'}
  <newStrategicPlan />
  %table.table.borderless{:style => "width: 500px;"}
    %tbody
      {{#strategic_plans}}
      <strategicPlan title='{{title}}' id='{{id}}' />
      {{/strategic_plans}}

%style
  a { cursor : pointer; }
  a.disallowed { cursor : not-allowed; opacity : 0.75; }

%script#strategic_plan_template{:type => 'template/ractive'}
  %tr.strategic_plan{'intro-outro' => :fade}
    %td {{title}}
    %td
      %a{:class => 'delete_strategic_plan {{#unless delete_permitted}}disallowed{{/unless}}', 'on-click' => "delete_if_permitted()"}= t('delete')

:coffeescript
  StrategicPlan = Ractive.extend
    template : '#strategic_plan_template'
    computed :
      delete_confirmation_message : -> "#{t('.delete_confirmation_message')}" + "\""+@get('title') + "\"" + "?"
      url : -> Routes.corporate_services_strategic_plan_path('en',@get('id'))
      delete_permitted : -> #{@delete_permitted}
    delete_if_permitted : ->
      if @get('delete_permitted')
        @show_confirm_delete_modal()
    delete_callback : ->
      @parent.remove(@)
    , ConfirmDeleteModal

  NewStrategicPlan = Ractive.extend
    template : '#new_strategic_plan_template'
    oninit : ->
      @validator = new Validator(@)
      @set
        validation_criteria :
          title : 'notBlank'
          unique_title : ['unique',_(@parent.get('strategic_plans')).pluck('title')]
    computed :
      unique_title : -> @get('title')
    data :
      title : "" 
      url : Routes.corporate_services_strategic_plans_path('en')
    submit : ->
      if @validate()
        data = {strategic_plan : {title : @get('title'), copy : @get('copy')}}
        $.ajax
          url : @get('url')
          method : 'post'
          data : data
          success : @create_callback
          context : @
      else
        $('.form-group').addClass('has-error')
    validate : ->
      @validator.validate()
    remove_error : ->
      $('.form-group').removeClass('has-error')
    create_callback : (data, status, jqxhr)->
      @set(title : "", copy : false)
      @parent.add_strategic_plan(data)

  @strategic_plans = new Ractive
    el: '#strategic_plans'
    template: '#strategic_plans_template'
    data :
      strategic_plans : #{@strategic_plans.to_json}
    components :
      strategicPlan : StrategicPlan
      newStrategicPlan : NewStrategicPlan
    remove : (strategic_plan)->
      $("#strat_plan .dropdown-menu li:contains("+strategic_plan.get('title')+")").remove()
      index = @findAllComponents('strategicPlan').indexOf(strategic_plan)
      @splice('strategic_plans',index,1)
    add_strategic_plan : (strategic_plan)->
      href = Routes.corporate_services_strategic_plan_path('en',strategic_plan.id)
      $('#strat_plan .dropdown-menu').append("<li id='sp_item'><a href='"+href+"'>"+strategic_plan.title+"</a></li>")
      @push('strategic_plans',strategic_plan)
