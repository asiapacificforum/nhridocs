%script#show_strategic_priority{:type => 'text/ractive'}
  .panel.panel-default.strategic_priority.editable_container{"data-url" => "{{ url }}", :id => "strategic_priority_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .panel-heading.strategic_priority_title
      %h4.panel-title.clearfix
        .row
          .col-md-2{'data-toggle' => 'edit', 'data-editable_attribute' => 'priority_level'}
            .fade.edit
              %select.form-control#strategic_priority_priority_level{:style => "height: initial; width: initial; margin-left: -10px; margin-top: -3px;", :name => 'strategic_priority[priority_level]', :value => "{{priority_level}}"}
                - priority_level_options.each do |opt|
                  %option{:value => opt[1]}= opt[0]
            .fade.no_edit
              %span= t('.strategic_priority')
          .col-lg-6{'data-toggle' => 'edit', 'data-editable_attribute' => 'description'}
            .fade.edit
              %input.form-control#strategic_priority_description{:'data-name' => :description, :name => "strategic_priority[description]", :'value' => "{{ description }}", :style => 'width:40px; height: 25px; margin-top: -3px; font-size: 16px; padding:0px;'}
            .fade.no_edit
              %span {{ description }}
          .col-lg-1{:style => "text-align:center; font-size:14px;", "data-parent" => "#strategic_plan", "data-toggle" => "collapse", :href => "#collapse{{id}}"}
            %i.fa.fa-folder-o.fa-lg#toggle
          .col-lg-1.icon{:style => "text-align:center; font-size:14px; height:20px", 'data-toggle' => 'edit'}
            .fade.edit
              %i.fa.fa-remove.fa-lg{:style => "position:relative; left:30px;", :id => "strategic_priority_editable{{id}}_edit_cancel"}
          .col-lg-1.icon{:style => "text-align:center; font-size:14px;", 'data-toggle' => 'edit'}
            .fade.edit
              %i.fa.fa-check.fa-lg{:id => "strategic_priority_editable{{id}}_edit_save", :style => "position:relative; left:21px;"}
            .fade.no_edit
              %i.fa.fa-pencil-square-o.fa-lg{:id => "strategic_priority_editable{{id}}_edit_start"}
          .col-lg-1{:style => "text-align:center; font-size:14px;"}
            %i.fa.fa-trash-o.fa-sm#delete{'on-click' => 'delete()'}
    .panel-collapse.collapse.strategic_priority_content{:id => "collapse{{id}}"}
      .panel-body.table#planned_results
        .row.heading
          .col-md-2{:style=>"width:14.2857%"}= t('.planned_results')
          .col-md-2{:style=>"width:14.2857%"}= t('.outcomes')
          .col-md-2{:style=>"width:14.2857%"}= t('.activities')
          .col-md-2{:style=>"width:14.2857%"}= t('.perf_indicators')
          .col-md-2{:style=>"width:14.2857%"}= t('.target')
          .col-md-2{:style=>"width:14.2857%"}= t('.reminders')
          .col-md-2{:style=>"width:14.2857%"}= t('.progress')
        {{#planned_results}}
        <pr description="{{description}}" indexed_description="{{indexed_description}}" id="{{id}}" outcomes="{{outcomes}}"/>
        {{/planned_results}}
        .row
          .col-md-2{:style=>"width:14.2857%"}
            %i.fa.fa-plus.fa-sm.new_planned_result{'on-click' => 'new_planned_result()', :style => 'position:relative; z-index:9'}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}

%script#new_strategic_priority_template{:type => 'text/ractive'}
  .panel.panel-default.new_strategic_priority
    = form_for :strategic_priority, :url => corporate_services_strategic_plan_strategic_priorities_path("spid").gsub(/spid/,"{{spid}}"), :remote => true, :html => {:id => :new_strategic_priority, :style => "padding:6px 0px"} do |f|
      .form-inline
        .form-group
          =f.label :priority_level, t('.priority'), :class => 'control-label sr-only'
          #priority_level_error.error{:style => 'padding-left:6px;', 'data-message' => t('.priority_level_error_message')} {{ priority_level_error }} &nbsp;
          =f.select :priority_level, priority_level_options, {:include_blank => 'Select priority level'}, {'on-change' => 'remove_priority_level_errors()', :class => 'form-control sp-select', :value => "{{priority_level}}"}
        .form-group.clearfix
          =f.label :description, t('.description'), :class => 'control-label sr-only'
          #description_error.error{:style => "float:left;", 'data-message' => t('.description_error_message')} {{ description_error }} &nbsp;
          .chars_remaining{:style => "float:right"}= t('.chars_remaining')
          =f.text_field :description, :class => 'form-control', :placeholder => "Enter description", :size => 100, :maxlength => 100, :value => "{{description}}", 'on-keydown' => "remove_description_errors()"
        .form-group
          .nothing{:style => 'visibility:hidden'} nothing
          %i.fa.fa-remove.fa-lg#edit_cancel{:style => 'padding-left:30px', 'on-click'=>'cancel()'}
          %i.fa.fa-check.fa-lg#edit-save{:style => 'padding-left:30px', 'on-click'=>'save()'}

%script#strategic_priority_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_strategic_priority_template }}
  {{else}}
  {{> show_strategic_priority }}
  {{/if}}

%script#strategic_plan_template{:type => 'text/ractive'}
  {{#strategic_priorities }}
  <sp id="{{id}}" description="{{description}}" priority_level="{{priority_level}}" url="{{url}}" planned_results="{{planned_results}}"/>
  {{/strategic_priorities}}

%script#planned_result_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_planned_result_template }}
  {{else}}
  {{> show_planned_result_template }}
  {{/if}}

%script#show_planned_result_template{:type => 'text/ractive'}
  .row.planned_result.editable_container{:id => "planned_result_editable{{id}}", :decorator => 'inpage_edit:{{id}}', :style => "vertical-align:top"}
    .col-md-2.description{ 'data-toggle' => 'edit', 'data-id' => '{{id}}', :style=>"width:14.2857%"}
      .fade.no_edit{ 'onMouseOver' => "$(this).find('.delete_icon').show()", 'onMouseOut' => "$(this).find('.delete_icon').hide()"}
        %span{:id => "planned_result_editable{{id}}_edit_start", :style => 'cursor:pointer'}
          {{ indexed_description }}
        %span.delete_icon{:style => 'float:right; display:none', 'on-click'=>'delete_this(event)'}
          %i.fa.fa-sm.fa-trash-o
      .fade.edit{:style=>"margin-left:16px"}
        // using the rails form helper foils the ractivjs 2-way binding, which needs a 'value' attribute!
        %textarea{:id => 'planned_result_description', :value => '{{description}}', :name => 'planned_result[description]'}
        .icon{'data-toggle' => 'edit', :style => 'height:20px'}
          %i.fa.fa-remove.fa-lg{:id => "planned_result_editable{{id}}_edit_cancel", :style => "margin-left:40px"}
          %i.fa.fa-check.fa-lg{:id => "planned_result_editable{{id}}_edit_save", :style => "margin-left:56px"}
    .col-md-10{:style=>"width:85.7143%"}
      {{#outcomes:i}}
      <outcome id="{{id}}" planned_result_id="{{planned_result_id}}" description="{{description}}" indexed_description="{{indexed_description}}" url="{{url}}"/>
      {{/outcomes}}
  .row
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
      %i.fa.fa-plus.fa-sm.new_outcome{'on-click' => 'new_outcome()', :style => 'position:relative; z-index:9'}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}

%script#new_planned_result_template{:type => 'text/ractive'}
  .row.new_planned_result
    .col-md-2{:style=>"width:14.2857%"}
      #description_error.error{'data-message' => t('.description_error_message')} {{ description_error }}
      %div=text_area :planned_result, :description, 'on-keydown' => "remove_description_errors()",
            :cols => 24, :rows => 4,
            :id=>'planned_result_description', :placeholder => "Enter description",
            'data-name' => :description, :name => "planned_result[description]",
            :'value' => "{{ description }}", :style => 'margin-top: -3px; font-size: 14px; padding:0px; position:relative; z-index:10; width:100%'
    .col-md-2{:style=>"width:14.2857%"}
      %div=text_area "planned_result.outcomes", :description,
            :cols => 24, :rows => 4,
            :id=>'planned_result_outcomes__description', :placeholder => "Enter description",
            'data-name' => :description, :name => "planned_result[outcomes_attributes][][description]",
            :'value' => "{{ description }}", :style => 'margin-top: -3px; font-size: 14px; padding:0px; position:relative; z-index:10; width:100%'
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
  .row
    .col-md-2{:style=>"width:14.2857%"}
      %i.fa.fa-remove.fa-lg#create_stop{'on-click'=>'create_stop()', :style => "margin-left:12px"}
      %i.fa.fa-check.fa-lg#create_save{'on-click'=>'create_save()', :style => "margin-left:40px"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}

%script#outcome_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_outcome_template }}
  {{else}}
  {{> show_outcome_template }}
  {{/if}}

%script#new_outcome_template{:type => 'text/ractive'}
  .row#new_outcome
    .col-md-2.description{:style=>"width:16.6667%"}
      #description_error.error{'data-message' => t('.description_error_message')} {{ description_error }}
      %div
        %textarea{:id=>'new_outcome_description', :placeholder => "Enter description",
          :name => "outcome[description]", 'on-keydown' => "remove_description_errors()",
          :style => 'margin-top: -3px; font-size: 14px; padding:0px; position:relative; z-index:10; width:100%'}
  .row
    .col-md-2{:style=>"width:16.6667%"}
      %i.fa.fa-remove.fa-lg#create_stop{'on-click'=>'create_stop()', :style => "margin-left:12px"}
      %i.fa.fa-check.fa-lg#create_save{'on-click'=>'create_save()', :style => "margin-left:40px"}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}

%script#show_outcome_template{:type => 'text/ractive'}
  .row.outcome.editable_container{:id => "outcome_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .col-md-2.description{'data-toggle' => 'edit', :style=>"width:16.6667%"}
      .fade.no_edit{ 'onMouseOver' => "$(this).find('.delete_icon').show()", 'onMouseOut' => "$(this).find('.delete_icon').hide()"}
        %span{:id => "outcome_editable{{id}}_edit_start", :style => 'cursor:pointer'}
          {{ indexed_description }}
        %span.delete_icon{:style => 'float:right; display:none', 'on-click'=>'delete_this(event,this)'}
          %i.fa.fa-sm.fa-trash-o
      .fade.edit{:style => "margin-left:16px"}
        %textarea{ :id=>'outcome_{{id}}_description', :placeholder => "Enter description",
            'data-name' => :description, :name => "outcome[description]", :value => "{{ description }}"}
        .icon{'data-toggle' => 'edit', :style => 'height:16.6667px; background-color:white; top:-2px'}
          %i.fa.fa-remove.fa-lg{:id => "outcome_editable{{id}}_edit_cancel", :style => "margin-left:40px"}
          %i.fa.fa-check.fa-lg{:id => "outcome_editable{{id}}_edit_save", :style => "margin-left:56px"}
    .col-md-2{:style=>"width:83.3333%"}
      {{#activities}}
      <activity outcome_id="{{outcome_id}}" description="{{description}}" indexed_description="{{indexed_description}}" performance_indicator="{{performance_indicator}}" indexed_performance_indicator="{{indexed_performance_indicator}}" target="{{target}}" \>
      {{/activities}}
      {{^activities}}
      .col-md-2{:style=>"width:20%"}
      .col-md-2{:style=>"width:20%"}
      .col-md-2{:style=>"width:20%"}
      .col-md-2{:style=>"width:20%"}
      .col-md-2{:style=>"width:20%"}
      {{/activities}}
  .row
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}
      %i.fa.fa-plus.fa-sm.new_activity{'on-click' => 'new_activity()', :style => 'position:relative; z-index:9'}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:16.6667%"}

%script#activity_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_activity_template }}
  {{else}}
  {{> show_activity_template }}
  {{/if}}

%script#new_activity_template{:type => 'text/ractive'}
  .row.new_activity
    .col-md-2.description{:style=>"width:20%"}
      #description_error.error{'data-message' => t('.description_error_message')} {{ description_error }}
      %textarea{ :id=>'new_activity_description', :placeholder => "Enter description",
                 :name => "activity[description]"}
    .col-md-2{:style=>"width:20%"}
      %textarea{ :id=>'new_activity_performance_indicator', :placeholder => "Enter performance indicator",
                 :name => "activity[performance_indicator]"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
  .row
    .col-md-2.description{:style=>"width:20%"}
      %i.fa.fa-remove.fa-lg#create_stop{'on-click'=>'create_stop()', :style => "margin-left:36px"}
      %i.fa.fa-check.fa-lg#create_save{'on-click'=>'create_save()', :style => "margin-left:56px"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}

%script#show_activity_template{:type => 'text/ractive'}
  .row.activity.editable_container{:id => "activity_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .col-md-2.description{'data-toggle' => 'edit', :style=>"width:20%"}
      .fade.no_edit{ 'onMouseOver' => "$(this).find('.delete_icon').show()", 'onMouseOut' => "$(this).find('.delete_icon').hide()"}
        %span{:id => "activity_editable{{id}}_edit_start", :style => 'cursor:pointer'}
          {{ indexed_description }}
        %span.delete_icon{:style => 'float:right; display:none', 'on-click'=>'delete_this(event,this)'}
          %i.fa.fa-sm.fa-trash-o
      .fade.edit{:style => "margin-left:16px"}
        %textarea{ :id=>'activity_{{id}}_description', :placeholder => "Enter description",
            'data-name' => :description, :name => "activity[description]", :value => "{{ description }}"}
        .icon{'data-toggle' => 'edit', :style => 'height:20px; background-color:white; top:-2px'}
          %i.fa.fa-remove.fa-lg{:id => "activity_editable{{id}}_edit_cancel", :style => "margin-left:36px"}
          %i.fa.fa-check.fa-lg{:id => "activity_editable{{id}}_edit_save", :style => "margin-left:56px"}
    .col-md-2.performance_indicator{'data-toggle'=>'edit', :style=>"width:20%"}
      .fade.no_edit
        %span{:id => "activity_editable{{id}}_edit_start", :style => 'cursor:pointer'}
          {{ indexed_performance_indicator }}
      .fade.edit{:style => "margin-left:16px"}
        %textarea{ :id=>'activity_{{id}}_performance_indicator', :placeholder => "Enter performance indicator",
            'data-name' => :performance_indicator, :name => "activity[performance_indicator]", :value => "{{ performance_indicator }}"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}

:coffeescript
  $ ->
    Ractive.DEBUG = false

    strategic_plan_data = #{@strategic_plan.to_json}

    InpageEdit = @InpageEdit

    Activity = Ractive.extend
      template : '#activity_template'
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      create_stop : ->
        @parent.remove_activity_form()
      create_save : ->
        context = $(@el)
        url = @parent.get('create_activity_url')
        data = context.find('.row.new_activity :input').serializeArray()
        data.push({name: 'activity[outcome_id]', value : @get('outcome_id')})
        data = @strip_whitespace(data)
        if @validate(data)
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_activity
            context : @
      strip_whitespace : (data)->
        _(data).map (obj)->
          _(obj).mapObject (val)->
            if typeof val == 'string'
              val.trim()
            else
              val
      validate : (data) ->
        message = $('.new_activity #description_error').data('message')
        field_obj = _(data).find (d)->
          d.name=="activity[description]"
        if field_obj.value == ""
          @set("description_error",message)
          false
        else
          true
      create_activity : (response, statusText, jqxhr)->
        @parent.set('activities',response)
        #@parent.show_add_activity()
      delete_this : (event,object)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_activity
      update_activity : (resp, statusText, jqxhr)->
        @parent.set(resp)


    Outcome = Ractive.extend
      template : '#outcome_template'
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      components :
        activity : Activity
      create_stop : ->
        @parent.remove_outcome_form()
      create_save : ->
        context = $(@el)
        url = @parent.get('create_outcome_url')
        data = context.find('.row#new_outcome :input').serializeArray()
        data.push({name: 'outcome[planned_result_id]', value : @get('planned_result_id')})
        data = @strip_whitespace(data)
        if @validate(data)
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_outcome
            context : @
      strip_whitespace : (data)->
        _(data).map (obj)->
          _(obj).mapObject (val)->
            if typeof val == 'string'
              val.trim()
            else
              val
      validate : (data) ->
        message = $('#new_outcome #description_error').data('message')
        field_obj = _(data).find (d)->
          d.name=="outcome[description]"
        if field_obj.value == ""
          @set("description_error",message)
          false
        else
          true
      create_outcome : (response, statusText, jqxhr)->
        @parent.set('outcomes',response)
        @parent.show_add_outcome()
      remove_description_errors : ->
        @set("description_error","")
      delete_this : (event,object)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_pr
      update_pr : (resp, statusText, jqxhr)->
        @parent.set(resp)
      new_activity : ->
        @push('activities',{description : '', indexed_description: '', performance_indicator: '', target: '', id : null, outcome_id : @get('id'), url:null})

    PlannedResult = Ractive.extend
      template : '#planned_result_template'
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      components :
        outcome : Outcome
      oninit : ->
        if !@get('persisted')
          @parent.hide_add_planned_result()
      create_stop : ->
        @parent.remove_planned_result_form()
      create_save : ->
        context = $(@el)
        url = @parent.get('create_planned_result_url')
        data = context.find('.new_planned_result :input').serializeArray()
        data.push({name: 'planned_result[strategic_priority_id]', value : @get('strategic_priority_id')})
        data = @strip_whitespace(data)
        if @.validate(data)
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_pr
            context : @
      strip_whitespace : (data)->
        _(data).map (obj)->
          _(obj).mapObject (val)->
            if typeof val == 'string'
              val.trim()
            else
              val
      validate : (data) ->
        message = $('.new_planned_result #description_error').data('message')
        field_obj = _(data).find (d)->
          d.name=="planned_result[description]"
        if field_obj.value == ""
          @set("description_error",message)
          false
        else
          true
      remove_description_errors : ->
        @set("description_error","")
      create_pr : (response, statusText, jqxhr)->
        @parent.set('planned_results',response)
        @parent.show_add_planned_result()
      delete_this : (event)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'id', value:@get('id')}, {name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_all_pr
      update_pr : (response, statusText, jqxhr)->
        @set(response)
      update_all_pr : (response, statusText, jqxhr)->
        @parent.set('planned_results',response)
      new_outcome : ->
        @push('outcomes',{description : '', indexed_description: '', id : null, planned_result_id : @get('id'), url:null})
        @hide_add_outcome()
      remove_outcome_form : ->
        @pop('outcomes')
        @show_add_outcome()
      _add_outcome : ->
        $(@parent.el).
          find('.new_outcome').
          closest('.row')
      hide_add_outcome : ->
        @_add_outcome().hide()
      show_add_outcome : ->
        @_add_outcome().show()

    # response to save is assumed to be an array of all
    # the strategic priorities on the page
    EditInPlace = (node,id)->
      ractive = @
      @edit = new InpageEdit
        on : node
        object : @
        focus_element : 'input.title'
        success : (response, textStatus, jqXhr)->
          ractive = @.options.object
          # the whole dataset is replaced... Ractive figures out
          # what has changed and what to re-render
          strategic_plan.set('strategic_priorities',response)
          @.show()
        error : ->
          console.log "Changes were not saved, for some reason"
      return {
        teardown : (id)->
          # ractive.edit.off()
        update : (id)->
          if _.isUndefined(id)
            # ractive.edit.off()
          else
            # item was added
            # enable EditInPlace for the node
            @edit = new InpageEdit
              on : node
              object : @
              focus_element : 'input.title'
              success : (response, textStatus, jqXhr)->
                ractive = @.options.object
                # the whole dataset is replaced... Ractive figures out
                # what has changed and what to re-render
                strategic_plan.set('strategic_priorities',response)
                @.show()
              error : ->
                console.log "Changes were not saved, for some reason"
            }

    Ractive.decorators.inpage_edit = EditInPlace

    StrategicPriority = Ractive.extend
      template : '#strategic_priority_template'
      components :
        pr : PlannedResult
      computed :
        length : ->
          if @.get('description')
            @.get('description').length
          else
            0
        count : ->
          Math.max(0,(100 - @.get('length')))
        spid : ->
          window.strategic_plan.get('id')
        persisted : ->
          !isNaN(parseInt(@.get('id')))
      new_planned_result: ->
        @.push('planned_results', {id : null, description : "", strategic_priority_id : @.get('id')})
      cancel : ->
        @.parent.get('strategic_priorities').shift() # it's only the first one that ever gets cancelled
      form : ->
        $(@.nodes.new_strategic_priority)
      save : ->
        data = @.form().serializeArray()
        url = @.form().attr('action')
        data = @strip_whitespace(data)
        if @.validate(data)
          $.post(url, data, @.update_sp, 'json')
      update_sp : (data,textStatus,jqxhr)->
        strategic_plan.set('strategic_priorities', data)
      delete : ->
        data = {'_method' : 'delete'}
        # TODO if confirm
        $.post(@.get('url'), data, @.update_sp, 'json')
      strip_whitespace : (data)->
        _(data).map (obj)->
          _(obj).mapObject (val)->
            if typeof val == 'string'
              val.trim()
            else
              val
      validate : (data) ->
        pl = @._validate(data,'priority_level')
        desc = @._validate(data,'description')
        pl && desc
      _validate : (data, field)->
        message = $('#'+field+'_error').data('message')
        reg = new RegExp(field)
        field_obj = _(data).find (d)->
                      reg.test(d.name)
        if field_obj.value == ""
          @.set(field+"_error",message)
          false
        else
          true
      remove_priority_level_errors : ->
        @.set("priority_level_error","")
      remove_description_errors : ->
        @.set("description_error","")
      _add_planned_result : ->
        $(@parent.el).
          find('.new_planned_result').
          closest('.row')
      hide_add_planned_result : ->
        @._add_planned_result().
          hide()
      show_add_planned_result : ->
        @._add_planned_result().
          show()
      remove_planned_result_form : ->
        @.pop('planned_results')
        @.show_add_planned_result()

    window.strategic_plan = new Ractive
      el : "#strategic_plan"
      template: "#strategic_plan_template"
      data: strategic_plan_data
      components :
        sp : StrategicPriority
      new_strategic_priority : ->
        # add only if there are no strategic priorities
        # of if the most recent is persisted
        if @.findAllComponents().length == 0 || @.findComponent().get('persisted')
          strategic_plan.unshift('strategic_priorities', {id:null, description: '', priority_level:null} )


