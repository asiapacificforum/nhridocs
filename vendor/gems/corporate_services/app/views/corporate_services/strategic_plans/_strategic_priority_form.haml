#new_strategic_priority.modal.fade # the container for the modal form

%script#strategic_priority_form{:type => 'text/ractive'}
  .modal-dialog
    .modal-content
      .modal-header
        %button.close{"data-dismiss" => "modal", :type => "button"}
          %i.fa.fa-times
        %h4#new_strategic_priority_label.modal-title= t('.new_strategic_priority')
      .modal-body
        = form_for :strategic_priority, :url => corporate_services_strategic_plan_strategic_priorities_path("spid").gsub(/spid/,"{{spid}}"), :remote => true, :html => {:id => :new_strategic_priority} do |f|
          .form-group
            =f.label :priority_level, t('.priority'), :class => 'control-label'
            =f.select :priority_level, (1..10), {}, {:class => 'form-control', :value => "{{priority_level}}"}
          .form-group.clearfix
            =f.label :description, t('.description'), :class => 'control-label', :style => "float:left;"
            .chars_remaining{:style => "float:right"}= t('.chars_remaining')
            =f.text_field :description, :class => 'form-control', :value => '{{value}}', 'on-keyup'=>'enforce_limit()'
          .modal-footer
            %button.btn.btn-default{"data-dismiss" => "modal", :type => "button", 'on-click'=>'reset_form()'}= t('defaults.cancel')
            %button.btn.btn-primary#add{:type => "button"}= t('.add')

%script#strategic_priority_template{:type => 'text/ractive'}
  {{#each strategic_priorities:sp }}
  .panel.panel-default
    #headingOne.panel-heading{:role => "tab"}
      %h4.panel-title
        %a{"data-parent" => "#accordion", "data-toggle" => "collapse", :href => "#collapseOne"}
          = t('.strategic_priority')
          {{ priority_level }}: {{ description }}
    #collapseOne.panel-collapse.collapse.in{:role => "tabpanel"}
      .panel-body
        %table.table
          %tr
            %td= t('.planned_results')
            %td= t('.outcomes')
            %td= t('.activities')
            %td= t('.perf_indicators')
            %td= t('.reminders')
            %td= t('.progress')
  {{/each}}

:coffeescript
  $ ->
    Ractive.DEBUG = false

    strategic_priorities = #{@strategic_priorities.to_json}

    strategic_plan_id = #{@strategic_plan.id}

    window.strategic_plan = new Ractive({
      el : "#strategic_plan"
      template: "#strategic_priority_template"
      data:
        id : strategic_plan_id
        strategic_priorities : strategic_priorities # the collection of strategic priorities
    })

    $('body').on "click", 'button#add', (event)->
      $(event.target).closest('form').submit()

    $('body').on "ajax:success", (e,data,status,xhr)->
      $('div#new_strategic_priority').modal('hide')
      strategic_priority_form.reset_form() # priority select box is not getting reset
      strategic_plan.set('strategic_priorities',data)

    $('form#new_strategic_priority').bind "ajax:error", ->
      console.log "error"

    window.strategic_priority_form = new Ractive({
      el : "#new_strategic_priority"
      template : "#strategic_priority_form"
      data :
        value : ""
        priority_level : 1
      computed : {
        length : ->
          @.get('value').length
        count : ->
          Math.max(0,(100 - @.get('length')))
        truncated_value : ->
          @.get('value').substring(0,100)
        spid : ->
          window.strategic_plan.get('id')
      }
      enforce_limit : ->
        @.set({'value': @.get('truncated_value') })
      reset_form : ->
        @.reset({value : "", priority_level : 1})
    })
