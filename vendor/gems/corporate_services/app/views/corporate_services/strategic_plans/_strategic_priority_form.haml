%script#show_strategic_priority{:type => 'text/ractive'}
  .panel.panel-default.strategic_priority.editable_container{"data-url" => "{{ url }}", :id => "strategic_priority_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .panel-heading.strategic_priority_title{:style => "color:#404040; background-color:rgba(140, 123, 85, 0.56); background-image:none; padding-bottom:4px; padding-top:15px;"}
      %h4.panel-title.clearfix
        .row
          .col-md-2.form-group.priority_level{'data-toggle' => 'edit', :class => "{{#priority_level_error}}has-error{{/}}", 'data-attribute'=>:strategic_priority}
            .fade.no_edit.in
              %span= t('.strategic_priority')
            .fade.edit
              %select.form-control#strategic_priority_priority_level{:style => "background-color:#D6CDB8; height: initial; width: initial; margin-left: 6px;", :name => 'strategic_priority[priority_level]', :value => "{{priority_level}}"}
                - priority_level_options.each do |opt|
                  %option{:value => opt[1]}= opt[0]
              %span.help-block#priority_level_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%"}= t('.priority_level_error_message')
          .col-md-6.form-group.description{'data-toggle' => 'edit', :class => "{{#description_error}}has-error{{/}}", 'data-attribute'=>:description}
            .fade.no_edit.in
              %span {{ description }}
            .fade.edit{:style=>"width:100%"}
              %input.form-control#strategic_priority_description{:name => "strategic_priority[description]", :'value' => "{{ description }}", :style => 'background-color:#D6CDB8; width:100%; font-size: 16px; margin-left:2px; height:22px;', 'on-keydown' => "remove_description_errors()"}
              %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%;"}= t('.description_error_message')
          .col-md-1{:style => "text-align:center; font-size:14px;", "data-parent" => "#strategic_plan", "data-toggle" => "collapse", :href => "#collapse{{id}}"}
            %i.fa.fa-folder-o.fa-lg#toggle
          .col-md-1.icon{:style => "text-align:center; font-size:14px; height:20px;", 'data-toggle' => 'edit'}
            .fade.edit
              %i.fa.fa-remove.fa-lg{:style => "position:relative; left:30px;", :id => "strategic_priority_editable{{id}}_edit_cancel"}
          .col-md-1.icon{:style => "text-align:center; font-size:14px;", 'data-toggle' => 'edit'}
            .fade.edit
              %i.fa.fa-check.fa-lg{:id => "strategic_priority_editable{{id}}_edit_save", :style => "position:relative; left:34px;"}
            .fade.no_edit.in
              %i.fa.fa-pencil-square-o.fa-lg{:id => "strategic_priority_editable{{id}}_edit_start"}
          .col-md-1{:style => "text-align:center; font-size:14px;"}
            %i.fa.fa-trash-o.fa-lg#delete{'on-click' => 'delete()'}
    .panel-collapse.collapse.strategic_priority_content{:id => "collapse{{id}}"}
      .panel-body.table#planned_results
        .row.heading{:style => "padding-top:0px; padding-bottom:0px; background-color: #ABA494;"}
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px;"}= t('.planned_results')
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px; background-color: #a59d8d"}= t('.outcomes')
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px; background-color: #9c9689"}= t('.activities')
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px; background-color: #9c9689"}= t('.perf_indicators')
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px; background-color: #9c9689"}= t('.target')
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px; background-color: #9c9689"}= t('.progress')
          .col-md-2{:style=>"width:14.2857%; padding-top:4px; padding-bottom: 4px; height: 48px; background-color: #9c9689"}= t('.reminders_etc')
        {{#planned_results}}
        <pr description="{{description}}" indexed_description="{{indexed_description}}" id="{{id}}" outcomes="{{outcomes}}"/>
        {{/planned_results}}
        .row
          .col-md-2{:style=>"width:14.2857%"}
            %i.fa.fa-plus.fa-sm.new_planned_result{'on-click' => 'new_planned_result()', :style => 'position:relative; z-index:9', 'data-toggle'=>"tooltip", 'data-placement'=>"right", :title=>"add planned result"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}
          .col-md-2{:style=>"width:14.2857%"}

%script#new_strategic_priority_template{:type => 'text/ractive'}
  .panel.panel-default.new_strategic_priority
    = form_for :strategic_priority, :url => corporate_services_strategic_plan_strategic_priorities_path("spid").gsub(/spid/,"{{spid}}"), :remote => true, :html => {:id => :new_strategic_priority, :style => "padding:6px 0px"} do |f|
      .form-inline
        .form-group{:class => "{{#priority_level_error}}has-error{{/}}", :style => "vertical-align: top"}
          .nothing{:style => 'visibility:hidden'} nothing
          =f.label :priority_level, t('.priority'), :class => 'control-label sr-only'
          =f.select :priority_level, priority_level_options, {:include_blank => 'Select priority level'}, {'on-change' => 'remove_priority_level_errors()', :class => 'form-control sp-select', :value => "{{priority_level}}"}
          %span.help-block#priority_level_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%; background-color:#fff"}= t('.priority_level_error_message')
        .form-group.clearfix{:class => "{{#description_error}}has-error{{/}}"}
          =f.label :description, t('.description'), :class => 'control-label sr-only'
          .chars_remaining{:style => "float:right"}= t('.chars_remaining')
          =f.text_field :description, :class => 'form-control', :placeholder => "Enter description", :size => 100, :maxlength => 100, :value => "{{description}}", 'on-keydown' => "remove_description_errors()"
          %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%; background-color:#fff"}= t('.description_error_message')
        .form-group
          .nothing{:style => 'visibility:hidden'} nothing
          %i.fa.fa-remove.fa-lg#edit_cancel{:style => 'padding-left:30px', 'on-click'=>'cancel()'}
          %i.fa.fa-check.fa-lg#edit-save{:style => 'padding-left:30px', 'on-click'=>'save()'}

%script#strategic_priority_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_strategic_priority_template }}
  {{else}}
  {{> show_strategic_priority }}
  {{/if}}

%script#strategic_plan_template{:type => 'text/ractive'}
  {{#strategic_priorities }}
  <sp id="{{id}}" description="{{description}}" priority_level="{{priority_level}}" url="{{url}}" planned_results="{{planned_results}}"/>
  {{/strategic_priorities}}

%script#planned_result_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_planned_result_template }}
  {{else}}
  {{> show_planned_result_template }}
  {{/if}}

%script#show_planned_result_template{:type => 'text/ractive'}
  .row.planned_result.editable_container{:id => "planned_result_editable{{id}}", :decorator => 'inpage_edit:{{id}}', :style => "vertical-align:top; display:flex;"}
    .col-md-2.form-group.description{ 'data-toggle' => 'edit', 'data-id' => '{{id}}', :style=>"width:14.2857%", :class=>"{{#description_error}}has-error{{/}}", 'data-attribute'=>:description}
      .fade.no_edit.in{ 'onMouseOver' => "$(this).find('.delete_icon').show()", 'onMouseOut' => "$(this).find('.delete_icon').hide()"}
        %span{:id => "planned_result_editable{{id}}_edit_start", :style => 'cursor:pointer'}
          {{ indexed_description }}
        %span.delete_icon{:style => 'float:right; display:none', 'on-click'=>'delete_this(event)'}
          %i.fa.fa-sm.fa-trash-o
      .fade.edit
        %textarea{:id => 'planned_result_description', :value => '{{description}}', :name => 'planned_result[description]', 'on-keydown' => "remove_description_errors()"}
        %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%; background-color:#fff"}= t('.description_error_message')
        .icon{'data-toggle' => 'edit', :style => 'height:20px'}
          %i.fa.fa-remove.fa-lg{:id => "planned_result_editable{{id}}_edit_cancel", :style => "margin-left:40px"}
          %i.fa.fa-check.fa-lg{:id => "planned_result_editable{{id}}_edit_save", :style => "margin-left:56px"}
    .col-md-10{:style=>"width:85.7143%{{^outcomes}}; display:flex{{/outcomes}}"}
      {{#outcomes:i}}
      <outcome id="{{id}}" planned_result_id="{{planned_result_id}}" description="{{description}}" indexed_description="{{indexed_description}}" url="{{url}}"/>
      {{/outcomes}}
      {{^outcomes}}
      .row.planned_result_control{:style => "display:flex; width:110%"}
        .col-md-2{:style=>"width:16.6667%"}
          %i.fa.fa-plus.fa-sm.new_outcome{'on-click' => 'new_outcome()', :style => 'position:relative; z-index:9', 'data-toggle'=>"tooltip", 'data-placement'=>"right", :title=>"add outcome"}
        .col-md-2{:style=>"width:83.3333%"}
      {{/outcomes}}
  {{#if outcomes.length != 0}}
  .row.planned_result_control{:style => "display:flex"}
    .col-md-2{:style=>"width:14.2857%"}
    .col-md-2{:style=>"width:14.2857%"}
      %i.fa.fa-plus.fa-sm.new_outcome{'on-click' => 'new_outcome()', :style => 'position:relative; z-index:9', 'data-toggle'=>"tooltip", 'data-placement'=>"right", :title=>"add outcome"}
    .col-md-2{:style=>"width:71.4285%"}
  {{/if}}

%script#new_planned_result_template{:type => 'text/ractive'}
  .row.new_planned_result
    .col-md-2.form-group{:style=>"width:14.2857%; margin-bottom:0px;", :class=>"{{#description_error}}has-error{{/}}"}
      %div
        %textarea{'on-keydown' => "remove_description_errors()",
            :cols => 24, :rows => 4,
            :id=>'planned_result_description', :placeholder => "Enter description",
            :name => "planned_result[description]",
            :value => "{{ description }}", :style => 'font-size: 14px; z-index:10; width:100%'}
        %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%; background-color:#fff"}= t('.description_error_message')
    .col-md-2{:style=>"width:85.7142%"}
  .row
    .col-md-2{:style=>"width:14.2857%"}
      %i.fa.fa-remove.fa-lg#create_stop{'on-click'=>'create_stop()', :style => "margin-left:12px"}
      %i.fa.fa-check.fa-lg#create_save{'on-click'=>'create_save()', :style => "margin-left:40px"}
    .col-md-2{:style=>"width:85.7142%"}

%script#outcome_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_outcome_template }}
  {{else}}
  {{> show_outcome_template }}
  {{/if}}

%script#new_outcome_template{:type => 'text/ractive'}
  .row#new_outcome
    .col-md-2.description.form-group{:style=>"width:16.6667%; margin-bottom:0px; padding-left:0px;", :class => "{{#description_error}}has-error{{/}}"}
      %textarea.form-control{:id=>'new_outcome_description', :placeholder => "Enter description",
        :name => "outcome[description]", 'on-keydown' => "remove_description_errors()",
        :value => "{{description}}",
        :style => 'font-size: 14px; padding:0px; z-index:10; width:initial; height:45px;'}
      %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%; background-color:inherit"}= t('.description_error_message')
  .row
    .col-md-2{:style=>"width:16.6667%"}
      %i.fa.fa-remove.fa-lg#create_stop{'on-click'=>'create_stop()', :style => "margin-left:12px"}
      %i.fa.fa-check.fa-lg#create_save{'on-click'=>'create_save()', :style => "margin-left:40px"}
    .col-md-2{:style=>"width:83.3335%"}

%script#show_outcome_template{:type => 'text/ractive'}
  .row.outcome.editable_container{:id => "outcome_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .col-md-2.description.form-group{'data-toggle' => 'edit', :style=>"width:16.6667%; padding-top:6px;", :class => "{{#description_error}}has-error{{/}}", 'data-attribute'=>:description}
      .fade.no_edit.in{ 'onMouseOver' => "$(this).find('.delete_icon').show()", 'onMouseOut' => "$(this).find('.delete_icon').hide()"}
        %span{:id => "outcome_editable{{id}}_edit_start", :style => 'cursor:pointer'}
          {{ indexed_description }}
        %span.delete_icon{:style => 'float:right; display:none', 'on-click'=>'delete_this(event,this)'}
          %i.fa.fa-sm.fa-trash-o
      .fade.edit
        %textarea.form-control{ :id=>'outcome_{{id}}_description', :placeholder => "Enter description",
            :name => "outcome[description]", :value => "{{ description }}", "on-keydown"=>"remove_description_errors()"}
        %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%"}= t('.description_error_message')
        .icon{'data-toggle' => 'edit', :style => 'height:16.6667px; top:0px'}
          %i.fa.fa-remove.fa-lg{:id => "outcome_editable{{id}}_edit_cancel", :style => "margin-left:40px"}
          %i.fa.fa-check.fa-lg{:id => "outcome_editable{{id}}_edit_save", :style => "margin-left:56px"}
    .col-md-2{:style=>"width:83.3333%", :class => "{{^activities}}empty{{/activities}}"}
      {{#activities}}
      <activity outcome_id="{{outcome_id}}" description="{{description}}" indexed_description="{{indexed_description}}" performance_indicator="{{performance_indicator}}" indexed_performance_indicator="{{indexed_performance_indicator}}" target="{{target}}" indexed_target="{{indexed_target}}" progress="{{progress}}"\>
      {{/activities}}
      {{^activities}}
      .row.activity
        .col-md-2{:style=>"width:100%"}
          %i.fa.fa-plus.fa-sm.new_activity{'on-click' => 'new_activity()', :style => 'position:relative; z-index:9; top:6px;', 'data-toggle'=>"tooltip", 'data-placement'=>"right", :title=>"add activity"}
      {{/activities}}
  {{#if activities.length != 0}}
  .row.activity_control
    .col-md-2{:style=>"width:16.6667%"}
    .col-md-2{:style=>"width:83.3335%"}
      %i.fa.fa-plus.fa-sm.new_activity{'on-click' => 'new_activity()', :style => 'position:relative; z-index:9', 'data-toggle'=>"tooltip", 'data-placement'=>"right", :title=>"add activity"}
  {{/if}}

%script#activity_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_activity_template }}
  {{else}}
  {{> show_activity_template }}
  {{/if}}

%script#new_activity_template{:type => 'text/ractive'}
  .row.new_activity
    .col-md-2.description.form-group{:style=>"width:20%; z-index:10", :class => "{{#description_error}}has-error{{/}}"}
      %textarea.form-control{ :id=>'new_activity_description', :placeholder => "Enter description",
        :name => "activity[description]", :style => "z-index:10; width: initial;", "on-keydown"=>"remove_description_errors()",
        :value => "{{description}}"}
      %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%"}= t('.description_error_message')
    .col-md-2{:style=>"width:20%; z-index:10"}
      %textarea.form-control{ :id=>'new_activity_performance_indicator', :placeholder => "Enter performance indicator",
        :name => "activity[performance_indicator]", :style => "z-index:10; width:initial;",
        :value => "{{performance_indicator}}"}
    .col-md-2{:style=>"width:20%; z-index:10"}
      %textarea.form-control{ :id=>'new_activity_target', :placeholder => "Enter target",
        :name => "activity[target]", :style => "z-index:10; width:initial;",
        :value => "{{target}}"}
    .col-md-2{:style=>"width:20%; z-index:10"}
      %textarea.form-control{ :id=>'new_activity_progress', :placeholder => "Enter progress",
        :name => "activity[progress]", :style => "z-index:10; width:initial;",
        :value => "{{progress}}"}
    .col-md-2{:style=>"width:20%"}
  .row.new_activity_control
    .col-md-2.description{:style=>"width:20%"}
      %i.fa.fa-remove.fa-lg#create_stop{'on-click'=>'create_stop()', :style => "margin-left:36px"}
      %i.fa.fa-check.fa-lg#create_save{'on-click'=>'create_save()', :style => "margin-left:56px"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}
    .col-md-2{:style=>"width:20%"}

%script#show_activity_template{:type => 'text/ractive'}
  .row.activity.editable_container{:id => "activity_editable{{id}}", :decorator => 'inpage_edit:{{id}}', :style => "padding-top:6px;"}
    .col-md-2.description.form-group{'data-toggle' => 'edit', :style=>"width:20%", :class => "{{#description_error}}has-error{{/}}", 'data-attribute'=>'description'}
      .fade.no_edit.in{ 'onMouseOver' => "$(this).find('.delete_icon').show()", 'onMouseOut' => "$(this).find('.delete_icon').hide()"}
        %span{:id => "activity_editable{{id}}_edit_start", :style => 'cursor:pointer'} {{ indexed_description }}
        %span.delete_icon{:style => 'float:right; display:none', 'on-click'=>'delete_this(event,this)'}
          %i.fa.fa-sm.fa-trash-o
      .fade.edit
        %textarea.form-control{ :id=>'activity_{{id}}_description', :placeholder => "Enter description",
            :name => "activity[description]", :value => "{{ description }}", :style => "width:initial; height:45px"}
        %span.help-block#description_error{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%;"}= t('.description_error_message')
        .icon{'data-toggle' => 'edit', :style => 'height:20px; top:0px'}
          %i.fa.fa-remove.fa-lg{:id => "activity_editable{{id}}_edit_cancel", :style => "margin-left:36px"}
          %i.fa.fa-check.fa-lg{:id => "activity_editable{{id}}_edit_save", :style => "margin-left:56px"}
    .col-md-2.performance_indicator{'data-toggle'=>'edit', :style=>"width:20%"}
      .fade.no_edit.in
        %span{:id => "activity_editable{{id}}_edit_start", :style => 'cursor:pointer'} {{ indexed_performance_indicator }}
      .fade.edit
        %textarea.form-control{ :id=>'activity_{{id}}_performance_indicator', :placeholder => "Enter performance indicator",
            :name => "activity[performance_indicator]", :value => "{{ performance_indicator }}", :style => "width:initial; height:45px;"}
    .col-md-2.target{'data-toggle'=>'edit', :style=>"width:20%"}
      .fade.no_edit.in
        %span{:id => "activity_editable{{id}}_edit_start", :style => 'cursor:pointer'} {{ indexed_target }}
      .fade.edit
        %textarea.form-control{ :id=>'activity_{{id}}_target', :placeholder => "Enter target",
            :name => "activity[target]", :value => "{{ target }}", :style => "width:initial; height:45px;"}
    .col-md-2.activity_progress{'data-toggle'=>'edit', :style=>"width:20%"}
      .fade.no_edit.in
        %span{:id => "activity_editable{{id}}_edit_start", :style => 'cursor:pointer'} {{ progress }}
      .fade.edit
        %textarea.form-control{ :id=>'activity_{{id}}_progress', :placeholder => "Enter progress",
            :name => "activity[progress]", :value => "{{ progress }}", :style => "width:initial; height:45px;"}
    .col-md-2.actions{:style=>"width:20%"}
      %div.alarm_icon{'on-click' => "show_reminders_panel()", :style => "position:relative; float:left; width:20px; top:3px; margin-left:20px;"}
      %i.fa.fa-file-text-o.show_notes{'on-click' => "show_notes_panel()", :style => "margin-left:28px; position:relative; float:left; top:3px;"}
      %div.rule{'on-click' => "show_rules_panel()"}
    <modal-custom id="reminders_modal" type="xl">
    <modal-header>
    <h4>#{t('.reminders')}<modal-close/></h4>
    </modal-header>
    <modal-body>
    <i class="fa fa-plus fa-sm" id="add_reminder" on-click='new_reminder()' data-toggle="tooltip" data-placement="bottom" title="add reminder"/>
    #reminders{:style => "margin-bottom:80px;"}
      .row
        %h5.col-md-1.tight{:style => "width:10%;"}= t('.type')
        %h5.col-md-1.tight{:style => "width:18%;"}= t('.next')
        %h5.col-md-1.tight{:style => "width:8%;"}= t('.previous')
        %h5.col-md-6.tight{:style => "width:41%;"}= t('.text')
        %h5.col-md-1.tight{:style => "width:13%;"}= t('.recipients')
        %h5.col-md-1.tight{:style => "width:3%;"}
        %h5.col-md-1.tight{:style => "width:3%;"}
        %h5.col-md-1.tight{:style => "width:3%;"}
      {{#reminders}}
      <reminder reminder_type="{{reminder_type}}" frequency="{{frequency}}" text="{{text}}" next="{{next}}" previous="{{previous}}" recipients="{{recipients}}"/>
      {{/reminders}}
    </modal-body>
    </modal-custom>
    <modal-custom id="notes_modal" type="xl">
    <modal-header>
    <h4>#{t('.notes')}<modal-close/></h4>
    </modal-header>
    <modal-body>
    <i class="fa fa-plus fa-sm" id="add_note" on-click='new_note()' data-toggle="tooltip" data-placement="bottom" title="add note"/>
    #notes{:style => "margin-bottom:80px;"}
      .row
        %h5.col-md-1{:style => "width:15%;"}= t('.date')
        %h5.col-md-1{:style => "width:70%;"}= t('.text')
      {{#notes}}
      <note date='{{date}}' author_name='{{author_name}}' updated_on='{{updated_on}}' editor_name='{{editor_name}}' text='{{text}}'/>
      {{/notes}}
    </modal-body>
    </modal-custom>
    <modal-custom id="rules_modal" type="xl">
    <modal-header>
    <h4>#{t('.rules')}<modal-close/></h4>
    </modal-header>
    <modal-body>
    #rules{:style => "margin-bottom:80px;"}
      .row
        %h5.col-md-1.col-md-offset-4{:style => "width:25%;"} Not yet implemented
    </modal-body>
    </modal-custom>

%script#note_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_note_template }}
  {{else}}
  {{> show_note_template }}
  {{/if}}

%script#new_note_template{:type => 'text/ractive'}
  .form-horizontal#new_note
    .form-group#text{:class => '{{#text_error}}has-error{{/}}'}
      %label.control-label.topaligned.col-sm-2= t('.text')
      .col-sm-10
        =text_area :note, :text, :size=>"78x4", :class => 'form-control', :style => "width:70%", :value => '{{text}}', 'on-keydown'=>"remove_errors('text')"
        %span.help-block= t('.note_text_error_message')
    .form-group
      .col-sm-10.col-sm-offset-2
        <i class="fa fa-remove fa-lg" id="cancel_note" style="padding-left:30px" on-click="cancel_note()" data-toggle="tooltip" data-placement="bottom" title="cancel"/>
        <i class="fa fa-check fa-lg" id="save_note" style="padding-left:60px" on-click="save_note()" data-toggle="tooltip" data-placement="bottom" title="save"/>

%script#show_note_template{:type => 'text/ractive'}
  .note.row.editable_container{:id => "note_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .col-md-1.date.form-group{:style => "width:15%"}
      %span {{ date }}
    .col-md-6.text.form-group{:class => '{{#text_error}}has-error{{/}}', :style => "width:65%", 'data-toggle'=>'edit', 'data-id'=>'{{id}}', 'data-attribute'=>'text'}
      %div
        .fade.no_edit.in
          %span {{text}}
        .fade.edit{:style => "height:140px;"}
          %textarea#note_text.form-control{:name => 'note[text]', :cols=>78, :rows=>4, :value => '{{text}}', 'on-keydown'=>"remove_errors('text')"}
          %span.help-block{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-8px; width:100%; background-color:#fff"}= t('.note_text_error_message')
    .col-md-1.icon.note_info{:style => "width:5%"}
      %i.fa.fa-info-circle.fa-lg{:decorator => 'popover'}
    .col-md-1.icon{:style => "text-align:center; font-size:14px; height:20px; width:5%", 'data-toggle' => 'edit'}
      .fade.edit
        %i.fa.fa-remove.fa-lg{:style => "position:relative;", :id => "note_editable{{id}}_edit_cancel"}
    .col-md-1.icon{:style => "text-align:center; font-size:14px; width:5%", 'data-toggle' => 'edit'}
      .fade.edit
        %i.fa.fa-check.fa-lg{:id => "note_editable{{id}}_edit_save"}
      .fade.no_edit.in{:style => "left:-14px;"}
        %i.fa.fa-pencil-square-o.fa-lg{:id => "note_editable{{id}}_edit_start"}
    .col-md-1{:style => "text-align:center; font-size:14px; width:5%;"}
      %i.fa.fa-trash-o.fa-lg#delete_note{'on-click' => 'delete_note(event,this)', :style => "position:relative; left:-12px; top:-2px;"}

%script#reminder_template{:type => 'text/ractive'}
  {{#if !persisted }}
  {{> new_reminder_template }}
  {{else}}
  {{> show_reminder_template }}
  {{/if}}

%script#show_reminder_template{:type => 'text/ractive'}
  .reminder.row.editable_container{:id => "reminder_editable{{id}}", :decorator => 'inpage_edit:{{id}}'}
    .col-md-1.tight.reminder_type.form-group{:class => '{{#reminder_type_error}}has-error{{/}}', :style => "width:10%", 'data-toggle' => 'edit', 'data-id' => '{{id}}', 'data-attribute'=>'reminder_type'}
      .fade.no_edit.in
        %span {{ reminder_type }}
      .fade.edit{:style => "height:140px;"}
        =select :reminder, :reminder_type, options_for_select(reminder_type_options),
          {:prompt => "select type"},
          {:style => "height:22px", :class => 'form-control', :value => '{{reminder_type}}', 'on-change'=>"remove_errors('reminder_type')"}
        %span.help-block{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-4px; width:100%; background-color:#fff"}= t('.reminder_type_error_message')
    .col-md-1.tight.next.form-group{:style => "width:18%", 'data-toggle'=>'edit', 'data-id'=>'{{id}}', 'data-attribute'=>'["start_month","start_day","start_year"]'}
      .fade.no_edit.in
        %span {{ next }}
      .fade.edit{:style => "height:140px;"}
        =select :reminder, "start_date_2i", start_month_options,{},{:name => "reminder[start_date(2i)]", :style=>"height:22px; width:4.5em; display:inline-block;", :class=>'form-control', :value => "{{start_month}}"}
        =select :reminder, "start_date_3i", (1..31),{},{:name => "reminder[start_date(3i)]", :style=>"height:22px; width:3.5em; display:inline-block;", :class=>'form-control', :value => "{{start_day}}"}
        =select :reminder, "start_date_1i", (Date.today.year..Date.today.year+5),{},{:name => "reminder[start_date(1i)]", :style=>"height:22px; width:5em; display:inline-block;", :class=>'form-control', :value => "{{start_year}}"}
    .col-md-1.tight.previous{:style => "width:9%"}{{ previous }}
    .col-md-6.tight.text.form-group{:class => '{{#text_error}}has-error{{/}}', :style => "width:40%", 'data-toggle'=>'edit', 'data-id'=>'{{id}}', 'data-attribute'=>'text'}
      %div
        .fade.no_edit.in
          %span {{text}}
        .fade.edit{:style => "height:140px;"}
          %textarea#reminder_text.form-control{:name => 'reminder[text]', :cols=>78, :rows=>4, :value => '{{text}}', 'on-keydown'=>"remove_errors('text')"}
          %span.help-block{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-8px; width:100%; background-color:#fff"}= t('.reminder_text_error_message')
    .col-md-1.tight.recipients.form-group{:class => '{{#user_ids_error}}has-error{{/}}', :style => "width:13%", 'data-toggle'=>'edit', 'data-id'=>'{{id}}', 'data-attribute'=>'user_ids'}
      .fade.no_edit.in
        {{#recipients}}
        <recipient first_last_name="{{ first_last_name  }}" />
        {{/recipients}}
      .fade.edit{:style => "height:140px;"}
        =select :reminder, :user_ids, options_for_select(recipients_options), {},
          {:multiple => true, :class=>'form-control', :value => '{{user_ids}}',
           'on-change'=>"remove_errors('user_ids')", :style => "height:82px;"}
        %span.help-block{:style => "font-size:0.8em; padding-left:4px; position:relative; top:-6px; width:100%; background-color:#fff"}= t('.reminder_recipients_error_message')
    .col-md-1.icon.tight{:style => "text-align:center; font-size:14px; height:20px; width:3%", 'data-toggle' => 'edit'}
      .fade.edit
        %i.fa.fa-remove.fa-lg{:style => "position:relative;", :id => "reminder_editable{{id}}_edit_cancel"}
    .col-md-1.icon{:style => "text-align:center; font-size:14px; width:3%", 'data-toggle' => 'edit'}
      .fade.edit
        %i.fa.fa-check.fa-lg{:id => "reminder_editable{{id}}_edit_save"}
      .fade.no_edit.in{:style => "left:-14px;"}
        %i.fa.fa-pencil-square-o.fa-lg{:id => "reminder_editable{{id}}_edit_start"}
    .col-md-1{:style => "text-align:center; font-size:14px; width:3%;"}
      %i.fa.fa-trash-o.fa-lg#delete_reminder{'on-click' => 'delete_reminder(event,this)', :style => "position:relative; left:-12px; top:-2px;"}

%script#new_reminder_template{:type => 'text/ractive'}
  .form-horizontal#new_reminder
    .form-group#reminder_type{:class => '{{#reminder_type_error}}has-error{{/}}'}
      %label.control-label.col-sm-2= t('.type')
      .col-sm-10
        =select :reminder, :reminder_type, options_for_select(reminder_type_options), {:prompt => "select type"}, {:class => 'form-control', :style => "width:31%", :value => '{{reminder_type}}', 'on-change'=>"remove_errors('reminder_type')"}
        %span.help-block= t('.reminder_type_error_message')
    .form-group
      %label.control-label.col-sm-2= t('.start_date')
      .col-sm-10
        =date_select :reminder, :start_date, {:start_year => Date.today.year}, {:class=>'form-control'}
    .form-group#text{:class => '{{#text_error}}has-error{{/}}'}
      %label.control-label.topaligned.col-sm-2= t('.text')
      .col-sm-10
        =text_area :reminder, :text, :size=>"78x4", :class => 'form-control', :style => "width:70%", :value => '{{text}}', 'on-keydown'=>"remove_errors('text')"
        %span.help-block= t('.reminder_text_error_message')
    .form-group#recipients{:class => '{{#user_ids_error}}has-error{{/}}'}
      %label.control-label.topaligned.col-sm-2= t('.recipient_s')
      .col-sm-10
        =select :reminder, :user_ids, options_for_select(recipients_options), {}, {:multiple => true, :class=>'form-control', :style => "width:24%", :value => '{{user_ids}}', 'on-change'=>"remove_errors('user_ids')"}
        %span.help-block= t('.reminder_recipients_error_message')
    .form-group
      .col-sm-10.col-sm-offset-2
        <i class="fa fa-remove fa-lg" id="cancel_reminder" style="padding-left:30px" on-click="cancel_reminder()" data-toggle="tooltip" data-placement="bottom" title="cancel"/>
        <i class="fa fa-check fa-lg" id="save_reminder" style="padding-left:60px" on-click="save_reminder()" data-toggle="tooltip" data-placement="bottom" title="save"/>

%script#recipient_template{:type => 'text/ractive'}
  %p.recipient{:style => "margin-bottom: 0px;"} {{ first_last_name }}

= render :partial => 'details_popover'
= render :partial => 'details_popover_content'
= render :partial => 'details_popover_title'

:coffeescript
  $ ->
    Ractive.DEBUG = false

    strategic_plan_data = #{@strategic_plan.to_json}

    Recipient = Ractive.extend
      template : '#recipient_template'

    Reminder = Ractive.extend
      template : '#reminder_template'
      components :
        recipient : Recipient
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      save_reminder : ->
        context = $(@el)
        url = @parent.get('create_reminder_url')
        data = context.find('#new_reminder :input').serializeArray()
        data.push({name: 'reminder[activity_id]', value : @get('activity_id')})
        if @validate(data)
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_reminder
            context : @
      cancel_reminder : ->
        @parent.pop('reminders')
      delete_reminder : (event,obj)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_reminder
      update_reminder : (resp, statusText, jqxhr)->
        @parent.set(resp)
      validate : ->
        type = @_validate('reminder_type')
        text = @_validate('text')
        user_ids = @_validate('user_ids')
        type && text && user_ids
      _validate : (field)->
        if _.isString(@get(field))
          @set(field, @get(field).trim())
        value = @get(field)
        if _.isArray(value) && value.length == 0
          @set(field+'_error',true)
          false
        else if value == "" || _.isNull(value)
          @set(field+'_error',true)
          false
        else
          true
      create_reminder : (response, statusText, jqxhr)->
        @parent.set('reminders',response)
      remove_errors : (field)->
        @set(field+"_error",false)

    Note = Ractive.extend
      template : '#note_template'
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      save_note : ->
        context = $(@el)
        url = @parent.get('create_note_url')
        data = context.find('#new_note :input').serializeArray()
        data.push({name: 'note[activity_id]', value : @get('activity_id')})
        if @validate(data)
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_note
            context : @
      cancel_note : ->
        @parent.pop('notes')
      delete_note : (event)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_note
      update_note : (resp, statusText, jqxhr)->
        @parent.set(resp)
      validate : ->
        @_validate('text')
      _validate : (field)->
        if _.isString(@get(field))
          @set(field, @get(field).trim())
        value = @get(field)
        if _.isArray(value) && value.length == 0
          @set(field+'_error',true)
          false
        else if value == "" || _.isNull(value)
          @set(field+'_error',true)
          false
        else
          true
      create_note : (response, statusText, jqxhr)->
        @parent.set('notes',response)
      remove_errors : (field)->
        @set(field+"_error",false)

    Activity = Ractive.extend
      template : '#activity_template'
      components :
        reminder : Reminder
        note : Note
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      create_stop : ->
        @parent.remove_activity_form()
      create_save : ->
        context = $(@el)
        url = @parent.get('create_activity_url')
        data = context.find('.row.new_activity :input').serializeArray()
        data.push({name: 'activity[outcome_id]', value : @get('outcome_id')})
        if @validate()
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_activity
            context : @
      validate : ->
        @set('description', @get('description').trim())
        if @get('description') == ""
          @set("description_error",true)
          false
        else
          true
      create_activity : (response, statusText, jqxhr)->
        UserInput.reset()
        @parent.set('activities',response)
        #@parent.show_add_activity()
      delete_this : (event,object)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_activity
      update_activity : (resp, statusText, jqxhr)->
        UserInput.reset()
        @parent.set(resp)
      remove_errors : ->
        @remove_description_errors()
      remove_description_errors : ->
        @set("description_error","")
      show_reminders_panel : ->
        $('#reminders_modal').modal('show')
      show_notes_panel : ->
        $('#notes_modal').modal('show')
      show_rules_panel : ->
        $('#rules_modal').modal('show')
      new_reminder : ->
        unless @_new_reminder_is_active()
          @push('reminders',{id:null, type:null, frequency:null, text:'', activity_id:@get('id')})
      _new_reminder_is_active : ->
        reminders = @findAllComponents('reminder')
        (reminders.length > 0) && _.isNull( reminders[reminders.length - 1].get('id'))
      new_note : ->
        unless @_new_note_is_active()
          @push('notes',{id:null, type:null, frequency:null, text:'', activity_id:@get('id')})
      _new_note_is_active : ->
        notes = @findAllComponents('note')
        (notes.length > 0) && _.isNull( notes[notes.length - 1].get('id'))

    Outcome = Ractive.extend
      template : '#outcome_template'
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      components :
        activity : Activity
      create_stop : ->
        @parent.remove_outcome_form()
      create_save : ->
        context = $(@el)
        url = @parent.get('create_outcome_url')
        data = context.find('.row#new_outcome :input').serializeArray()
        data.push({name: 'outcome[planned_result_id]', value : @get('planned_result_id')})
        if @validate()
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_outcome
            context : @
      validate : ->
        @set('description', @get('description').trim())
        if @get('description') == ""
          @set("description_error",true)
          false
        else
          true
      create_outcome : (response, statusText, jqxhr)->
        UserInput.reset()
        @parent.set('outcomes',response)
        @parent.show_add_outcome()
      remove_description_errors : ->
        @set("description_error","")
      remove_errors : ->
        @remove_description_errors()
      delete_this : (event,object)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_pr
      update_pr : (resp, statusText, jqxhr)->
        UserInput.reset()
        @parent.set(resp)
      new_activity : ->
        @push('activities',{description : '', indexed_description: '', performance_indicator: '', target: '', id : null, outcome_id : @get('id'), url:null, description_error:"", progress:""})
        UserInput.claim_user_input_request(@,'remove_activity_form')
      remove_activity_form : ->
        if _.isNull(@findAllComponents('activity')[@get('activities').length-1].get('id'))
          @pop('activities')

    PlannedResult = Ractive.extend
      template : '#planned_result_template'
      computed :
        persisted : ->
          !isNaN(parseInt(@get('id')))
      components :
        outcome : Outcome
      oninit : ->
        if !@get('persisted')
          @parent.hide_add_planned_result()
      create_stop : ->
        @parent.remove_planned_result_form()
      create_save : ->
        context = $(@el)
        url = @parent.get('create_planned_result_url')
        data = context.find('.new_planned_result :input').serializeArray()
        data.push({name: 'planned_result[strategic_priority_id]', value : @get('strategic_priority_id')})
        if @.validate(data)
          $.ajax
            type : 'post'
            url : url
            data : data
            dataType : 'json'
            success : @create_pr
            context : @
      validate : ->
        @set('description', @get('description').trim())
        if @get('description') == ""
          @set("description_error",true)
          false
        else
          true
      remove_description_errors : ->
        @set("description_error",false)
      remove_errors : ->
        @remove_description_errors()
      create_pr : (response, statusText, jqxhr)->
        UserInput.reset()
        @parent.set('planned_results',response)
        @parent.show_add_planned_result()
      delete_this : (event)->
        ev = $.Event(event)
        ev.stopPropagation()
        data = [{name:'id', value:@get('id')}, {name:'_method', value: 'delete'}]
        $.ajax
          url : @get('url')
          data : data
          method : 'post'
          dataType : 'json'
          context : @
          success : @update_all_pr
      update_pr : (response, statusText, jqxhr)->
        @set(response)
      update_all_pr : (response, statusText, jqxhr)->
        UserInput.reset()
        @parent.set('planned_results',response)
      new_outcome : ->
        UserInput.claim_user_input_request(@,'remove_outcome_form')
        @push('outcomes',{description : '', indexed_description: '', id : null, planned_result_id : @get('id'), url:null, description_error:""})
        @hide_add_outcome()
      remove_outcome_form : ->
        if _.isNull(@findAllComponents('outcome')[@get('outcomes').length-1].get('id'))
          @pop('outcomes')
        @show_add_outcome()
      _add_outcome : ->
        $(@parent.el).
          find('.new_outcome').
          closest('.row')
      hide_add_outcome : ->
        @_add_outcome().hide()
      show_add_outcome : ->
        @_add_outcome().show()

    # response to save is assumed to be an array of all
    # the strategic priorities on the page
    EditInPlace = (node,id)->
      ractive = @
      @edit = new InpageEdit
        on : node
        object : @
        focus_element : 'input.title'
        success : (response, textStatus, jqXhr)->
          ractive = @.options.object
          # the whole dataset is replaced... Ractive figures out
          # what has changed and what to re-render
          strategic_plan.set('strategic_priorities',response)
          @load()
        error : ->
          console.log "Changes were not saved, for some reason"
      return {
        teardown : (id)->
          # ractive.edit.off()
        update : (id)->
          if _.isUndefined(id)
            # ractive.edit.off()
          else
            # item was added
            # enable EditInPlace for the node
            # @edit = new InpageEdit
            #   on : node
            #   object : @
            #   focus_element : 'input.title'
            #   success : (response, textStatus, jqXhr)->
            #     ractive = @.options.object
            #     # the whole dataset is replaced... Ractive figures out
            #     # what has changed and what to re-render
            #     strategic_plan.set('strategic_priorities',response)
            #     @.show()
            #   error : ->
            #     console.log "Changes were not saved, for some reason"
            }

    Popover = (node)->
      $(node).popover
        html : true,
        title : ->
          $('#detailsTitle').html()
        content : ->
          data = Ractive.getNodeInfo(@).ractive.get()
          ractive = new Ractive
            template : '#detailsContent'
            data : data
          ractive.toHTML()
        template : $('#popover_template').html()
        trigger: 'hover'
      teardown: ->
        $(node).off('mouseenter')

    Ractive.decorators.inpage_edit = EditInPlace
    Ractive.decorators.popover = Popover

    StrategicPriority = Ractive.extend
      onconfig : ->
        @set('original_description', @get('description'))
        @set('original_priority_level', @get('priority_level'))
      template : '#strategic_priority_template'
      components :
        pr : PlannedResult
      computed :
        length : ->
          if @get('description')
            @get('description').length
          else
            0
        count : ->
          Math.max(0,(100 - @get('length')))
        spid : ->
          window.strategic_plan.get('id')
        persisted : ->
          !isNaN(parseInt(@get('id')))
      new_planned_result: ->
        UserInput.claim_user_input_request(@,'remove_planned_result_form')
        @push('planned_results', {id : null, description : "", strategic_priority_id : @get('id'), description_error:"", outcomes:[]})
      cancel : ->
        UserInput.reset()
        @parent.get('strategic_priorities').shift() # it's only the first one that ever gets cancelled
      form : ->
        $(@nodes.new_strategic_priority)
      save : ->
        data = @form().serializeArray()
        url = @form().attr('action')
        if @validate(data)
          $.post(url, data, @update_sp, 'json')
      update_sp : (data,textStatus,jqxhr)->
        UserInput.reset()
        strategic_plan.set('strategic_priorities', data)
      delete : ->
        data = {'_method' : 'delete'}
        # TODO if confirm
        $.post(@get('url'), data, @update_sp, 'json')
      validate : ->
        pl = @._validate('priority_level')
        desc = @._validate('description')
        pl && desc
      _validate : (field)->
        if _.isString(@get(field))
          @set(field, @get(field).trim())
        value = @get(field)
        if value == "" || _.isNull(value)
          @set(field+"_error",true)
          false
        else
          true
      remove_priority_level_errors : ->
        @set("priority_level_error",false)
      remove_description_errors : ->
        @set("description_error",false)
      remove_errors : ->
        @remove_priority_level_errors() && @remove_description_errors()
      _add_planned_result : ->
        $(@parent.el).
          find('.new_planned_result').
          closest('.row')
      hide_add_planned_result : ->
        @_add_planned_result().
          hide()
      show_add_planned_result : ->
        @_add_planned_result().
          show()
      cancel_child_add : ->
        @remove_planned_result_form()
      remove_planned_result_form : ->
        if _.isNull(@findAllComponents('pr')[@get('planned_results').length-1].get('id'))
          @pop('planned_results')
        @show_add_planned_result()

    window.strategic_plan = new Ractive
      el : "#strategic_plan"
      template: "#strategic_plan_template"
      data: strategic_plan_data
      components :
        sp : StrategicPriority
      new_strategic_priority : ->
        UserInput.claim_user_input_request(@,'remove_strategic_priorities_form')
        # add only if there are no strategic priorities
        # of if the most recent is persisted
        if @.findAllComponents().length == 0 || @.findComponent().get('persisted')
          strategic_plan.unshift('strategic_priorities', {id:null, description: '', priority_level:null} )
      remove_strategic_priorities_form : ->
        @get('strategic_priorities').shift() # it's only the first one that ever gets cancelled

